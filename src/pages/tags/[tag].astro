---
import BaseLayout from "../../layouts/BaseLayout.astro";
import PostCard from "../../components/misc/PostCard.astro";
import { getCollection } from "astro:content";
import { bodyMargin } from "../../styles/utility";

export async function getStaticPaths() {
  const posts = await getCollection("blogs");

  const tags = [...new Set(posts.map((post: any) => post.data.tags).flat())];

  return tags.map((tag) => {
    const filteredPosts = posts.filter((post: any) =>
      post.data.tags.includes(tag),
    );
    return {
      params: { tag },
      props: { posts: filteredPosts },
    };
  });
}

const { tag } = Astro.params;
const { posts } = Astro.props;
---

<BaseLayout
  title={tag}
  description={`Posts tagged with ${tag}`}
  image="./favicon.png"
  url={`https://lunakit.netlify.app/tags/${tag}`}
>
  <main class={`${bodyMargin}`}>
    <h1 class="my-6 text-4xl">{tag}</h1>
    <ul class="space-y-3">
      {
        posts.map((post: any) => {
          return (
            <li>
              <PostCard
                title={post.data.title}
                date={post.data.pubDate
                  .toLocaleString("en-GB", {
                    day: "numeric",
                    month: "short",
                    // year: "numeric",
                  })
                  .slice(0, 11)}
                url={`/posts/${post.id}`}
                tags={post.data.tags}
              />
            </li>
          );
        })
      }
    </ul>
  </main>
</BaseLayout>
